<dom-module id="surveys-page">
  <template>
    <style is="custom-style" include="shared-styles"></style>
    <style>
      paper-textarea { margin: 10px; }
    </style>
    <h2>Surveys</h2>
    <template is="dom-if" if="{{!_mode}}">
      <paper-material elevation="1">
        <paper-textarea label="Question" value="{{Question}}"></paper-textarea>
        <paper-input label="Option 1" value="{{One}}"></paper-input>
        <paper-input label="Option 2" value="{{Two}}"></paper-input>
        <template is="dom-if" if="{{Question}}">
          <card-display cards='{{display}}' viewable></card-display>
          <paper-fab icon="add" on-tap="add"></paper-fab>
        </template>
      </paper-material>
      <hr style="clear:both">
    </template>
    <card-data cards="{{cards}}" url="https://g1.firebaseio.com/demo/surveys" uid="{{uid}}" token="{{token}}"></card-data>

    <template is="dom-if" if="{{!pickUsers}}">
      <card-display cards="{{cards}}" pickable="{{pickable}}" selectable="{{selectable}}" selected="{{selected}}" on-picked="picked"></card-display>
    </template>
    <template is="dom-if" if="{{!_mode}}">
      <fab-menu label="Share / Delete" on-share="fabShare" on-delete="fabDelete" icon="touch-app" back-label="Cancel" back-icon="subdirectory-arrow-left" menu="{{_menu}}"></fab-menu>
    </template>
    <iron-ajax auto url="https://g1.firebaseio.com/demo/users.json?auth={{token}}" last-response="{{users}}"></iron-ajax>  
    <template is="dom-if" if="{{pickUsers}}">
      <card-display cards="{{usersAsA}}" selectable selected="{{selectedUsers}}" ></card-display>
    </template>
    <template is="dom-if" if="{{_mode}}">
      <hr style="clear:both">
      <paper-toolbar style="position:fixed;bottom:0;right:0;">
        <div class="container">
          <template is="dom-if" if="{{_modeIs('Share with selected user')}}">
            <template is="dom-if" if="{{selectedUsers.length}}">
              <paper-button on-tap="doneIt" raised><iron-icon icon="done"></iron-icon>{{_mode}}</paper-button>
            </template>
          </template>
          <template is="dom-if" if="{{!_modeIs('Share with selected user')}}">
            <template is="dom-if" if="{{selected.length}}">
              <paper-button on-tap="doneIt" raised><iron-icon icon="done"></iron-icon>{{_mode}}</paper-button>
            </template>
          </template>
          <paper-button raised on-tap="cancel"><iron-icon icon="cancel"></iron-icon>cancel</paper-button>
        </div>
      </paper-toolbar>
    </template>
    <iron-ajax id="set" method="POST" ></iron-ajax>
  </template>
  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'surveys-page',
        properties: {
          display: {computed :"getDisplay(Question, One, Two)"}, 
          cards: {type: Array, value:[]},
          usersAsA: {computed:"objectToArray(users)"},
          _menu:{ 
            value: [
              {label:"Delete",icon:"delete",fire:{type:"delete"}},
              {label:"Share",icon:"social:share",fire:{type:"share"}}
            ],
            type: Array
          },
          _select: {type: Array},
          _mode: {type: String, value: ""},
          pickUsers: {type: Boolean, value: false},
        },
        getDisplay: function(Question, One, Two) {
          return [{data:"<center><h1>"+Question+"</h1><paper-button raised>"+One+"</paper-button><paper-button raised>"+Two+"</paper-button></center>","url":"custom"}]
        },
        add: function () {
          var hash = this.hash(this.uid, this.Question)
          var readableBy = {}
          readableBy[this.uid] = true
// TODO readableBy other Admins

          this.set("cards" ,this.cards.concat([{Question: this.Question, Two: this.Two, One: this.One, data:"<center><h1>{{Question}}</h1><{{tag}} raised>{{One}}</{{tag}}><{{tag}} raised>{{Two}}</{{tag}}></center>", tag:"paper-button", url:hash, readableBy:readableBy}]))

          this.set("Question","")
          this.set("One","")
          this.set("Two","")
        },
        hash: function(a,b) {
          function hex32(val) {
            val &= 0xFFFFFFFF
            var hex = val.toString(16).toUpperCase()
            return ("00000000" + hex).slice(-8)
          }
          var hash = 0
          var message = a+b
          if (message.length === 0) return hash
            for (i = 0;i < message.length;i++) {
              var char = message.charCodeAt(i)
              hash = ((hash<<5)-hash)+char
              hash = hash & hash // Convert to 32bit integer
            }
          return hex32(hash)
        },
        picked: function (e,d) {
          this.splice("cards",d ,1)
        },
        fabDelete: function() {
          this._mode = "Delete"
          this.set("pickable", true)
        },
        objectToArray: function (data) {
          var output = []
          if (data) {
            var keys = Object.keys(data)
            for (var i = 0; i < keys.length; i++) {
              if (typeof data[keys[i]] === 'object') {
                output.push(data[keys[i]])
              }
            }
          }
          return output
        },
        fabAdd: function(e,detail) {
          if (detail === "deck") {
            this._mode = "Add to a Deck"
            this.set("selectable", true)
          }
          if (detail === "card") {
            //add 
          }
        },
        fabShare: function() {
          this._mode = "share"
          this.set("selectable", true)
        },
        fabEdit: function() {
          this._mode = "Pick the card to edit it"
          this.set("pickable", true)
        },
        picked: function(e,d) {
          if (this._mode === "Pick the card to edit it") {
            // edit 
            this.set("editing", this.cards[d])
            this.set("editingIndex", d) 
            this.$.edit.open()
            
            this._mode = ""
          }
          if (this._mode === "Delete") {
            this.splice("cards", d, 1)
            this._mode = ""
            this.set("pickable", false)
          }
          
        },
        _modeIs:function(test) {
          return this._mode === test
        }, 
        doneIt: function() {
          if (this._mode === "share") {
            this._mode = "Share with selected user"
            this.set("pickUsers", true)
          } else if (this._mode === "Share with selected user") {
            // https://g1.firebaseio.com/share/yhg/google%3A108143381081229631011/cards
            this.set("_mode","")

            
            for (var s = 0; s < this.selected.length; s++) {
              for (var u = 0; u < this.selectedUsers.length; u++) {
                this.$.set.headers = {'content-type':'application/json'}
                this.$.set.body = JSON.stringify(this.cards[s])
                this.$.set.url = "https://g1.firebaseio.com/share/yhg/google:"+this.usersAsA[u].url.split(":")[2]+"/cards.json?auth="+this.token
                this.$.set.generateRequest()
              }
            }
            
            this.selectedUsers = [] 
            this.selected = []
        
            this.set("pickUsers", false)
            this.set("selectable", false)
            this.set("pickable", false)
          } else if (this._mode === "Add to a Deck") {
            var newDesk = {title:"New Deck", data: {}, url: "deck"}
            for (var i = 0; i < this.selected.length; i++) {
              newDesk.data["00"+i] = this.cards[this.selected[i]]
            }
            this.set("cards", this.cards.concat([newDesk]))
            this._mode = ""
            this.selected = []
            this.set("selectable", false)
            this.set("pickable", false)
          } else {
            this._mode = ""
            this.selected = []
            this.set("selectable", false)
            this.set("pickable", false)
          }
        },
        cancel: function() {
          this._mode = ""
          this.selected = []
          this.set("selectable", false)
          this.set("pickable", false)
        }
      });
    })();
  </script>
</dom-module>
